<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Parle avec Mimi — Démarrer une leçon</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f6ff;
      margin: 0;
      padding: 20px;
      color: #222;
    }
    h1 { color:#333; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #6a5acd;
      color: white;
      border: none;
      padding: 10px 16px;
      margin-top: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 14px;
      margin-top: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .mono { font-family: monospace; font-size: 14px; white-space: pre-wrap; }
    .gallery {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px;
    }
    .gallery img { width:100%; border-radius:8px; }
  </style>
</head>
<body>
  <h1>Parle avec Mimi — Démarrer une leçon</h1>

  <div class="card">
    <label>Chemin du fichier Supabase:</label>
    <input id="filePath" placeholder="uploads/Screenshot.png" />

    <label>Sujet (optionnel):</label>
    <input id="topic" placeholder="Ex: France et Francophonie" />

    <label>Texte PDF (optionnel):</label>
    <textarea id="pdfText" rows="3" placeholder="Colle ici un extrait de texte OCR..."></textarea>

    <label>Descriptions d'images (séparées par ;) :</label>
    <input id="imageHints" placeholder="Ex: Tour Eiffel; baguette" />

    <button id="btnStart">Démarrer la leçon</button>
    <div id="status"></div>
  </div>

  <div id="lessonBox" class="card" style="display:none;">
    <h2>Nouvelle leçon</h2>
    <div id="plan"></div>
    <div id="images"></div>
    <div id="tutor"></div>
  </div>

  <script>
    const API_BASE = "https://french-ai-tutor-api.onrender.com";
    const childIdDemo = "2e735737-96fc-4d46-8bb9-19f72d8f6215";

    const $ = sel => document.querySelector(sel);
    const statusEl = $("#status");

    function renderLesson(lesson){
      $("#lessonBox").style.display = "block";
      // Plan
      let planHtml = "<h3>Plan</h3>";
      (lesson.plan || []).forEach(s=>{
        planHtml += `<div><b>${s.name||""}</b> (${s.minutes||""} min)<br>${s.teacher_script||""}</div>`;
      });
      $("#plan").innerHTML = planHtml;

      // Image prompts
      let imgHtml = "<h3>Prompts d'images</h3>";
      (lesson.image_prompts || []).forEach(p=>{
        imgHtml += `<div class="mono">${p.prompt}</div>`;
      });
      $("#images").innerHTML = imgHtml;

      // Tutor first message
      const arr = lesson.first_tutor_messages || [];
      if(arr.length){
        $("#tutor").innerHTML = `<h3>Premiers messages du tuteur</h3><div>${arr[0]}</div>
          <button onclick="speak('${arr[0]}')">Écouter</button>`;
      }
    }

    function speak(text){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "fr-FR";
      window.speechSynthesis.speak(u);
    }

    $("#btnStart").onclick = async ()=>{
      const body = {
        topic: $("#topic").value.trim(),
        pdf_text: $("#pdfText").value.trim(),
        image_descriptions: $("#imageHints").value.trim() ? $("#imageHints").value.split(";") : []
      };
      statusEl.textContent = "⏳ En cours...";
      try{
        const r = await fetch(API_BASE + "/api/v2/lesson", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if(data.lesson){
          statusEl.textContent = "✅ Terminé";
          renderLesson(data.lesson);
        }else{
          statusEl.textContent = "❌ Erreur: " + JSON.stringify(data);
        }
      }catch(e){
        statusEl.textContent = "❌ Exception: " + e.message;
      }
    };
  </script>
</body>
</html>
